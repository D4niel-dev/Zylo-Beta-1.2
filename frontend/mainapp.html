<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Zylo | Main Window</title>
  <link rel="icon" href="/images/Zylo_icon.ico" type="image/x-icon" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0b1020" />
  <script src="/files/vendor/tailwindcss.js"></script>
  <link rel="stylesheet" href="/files/style.css">
  <script src="/files/vendor/feather-icons.js"></script>
  <link href="/files/vendor/cropper.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/files/vendor/emoji-mart.css" />
  <script src="/files/vendor/emoji-mart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            ringPulse: 'ringPulse 4s infinite ease-in-out',
            fadeIn: 'fadeIn 0.5s ease-out',
            slideIn: 'slideIn 0.3s ease-out'
          },
          keyframes: {
            ringPulse: {
              '0%, 100%': {
                boxShadow: '0 0 0 0 rgba(59,130,246,0.7)',
              },
              '50%': {
                boxShadow: '0 0 0 6px rgba(59,130,246,0)',
              },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideIn: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(0)' }
            },
            pop: {
            '0%': { transform: 'scale(0.9)', opacity: '0' },
            '100%': { transform: 'scale(1)', opacity: '1' }
            }
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col md:flex-row overflow-hidden">

<!-- Overlay -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

  <!-- Mobile Navbar -->
  <header class="fixed top-0 left-0 w-full flex items-center justify-between bg-white/80 dark:bg-gray-900/80 backdrop-blur-md shadow z-50 md:hidden">
    <button id="mobileMenuBtn" class="p-3 focus:outline-none" onclick="toggleSidebar()" onmouseenter="toggleMenuIcon(true)" onmouseleave="toggleMenuIcon(false)">
      <i id="mobileMenuIcon" data-feather="grid" class="w-6 h-6"></i>
    </button>
    <h1 class="text-lg font-semibold text-gray-800 dark:text-white">Zylo (Beta)</h1>
    <div class="w-12"></div>
  </header>

  <!-- Mobile Sidebar -->
  <div id="mobileSidebar" class="fixed top-0 left-0 h-full w-64 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-40 md:hidden">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Menu</h2>
        <button onclick="toggleSidebar()" class="text-gray-500 hover:text-red-500">‚úñ</button>
      </div>
    </div>
    
    <nav class="p-4 space-y-2">
      <a href="#" data-tab="home" onclick="switchTab('home'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="home" class="w-5 h-5"></i>
        <span>Home</span>
      </a>
      <a href="#" data-tab="chats" onclick="switchTab('chats'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="message-circle" class="w-5 h-5"></i>
        <span>Chats</span>
      </a>
      <a href="#" data-tab="profile" onclick="switchTab('profile'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="user" class="w-5 h-5"></i>
        <span>Profile</span>
      </a>
      <a href="#" data-tab="friends" onclick="switchTab('friends'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="users" class="w-5 h-5"></i>
        <span>Friends</span>
      </a>
      <a href="#" data-tab="groups" onclick="switchTab('groups'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="hash" class="w-5 h-5"></i>
        <span>Groups</span>
      </a>
      <a href="#" data-tab="explore" onclick="switchTab('explore'); toggleSidebar();" class="sidebar-tab">
        <i data-feather="compass" class="w-5 h-5"></i>
        <span>Explore</span>
      </a>
      <a href="#" data-tab="settings" onclick="switchTab('settings'); toggleSidebar();" class="sidebar-tab ">
        <i data-feather="settings" class="w-5 h-5"></i>
        <span>Settings</span>
      </a>
      <div>
        <a href="/login.html" class="sidebar-tab">
          <i data-feather="log-out" class="w-5 h-5"></i>
          <span>Logout</span>
        </a>
      </div>
    </nav>
  </div>

  <div class="flex w-full h-screen">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div>
        <div class="sidebar-header">
          <button onclick="toggleSidebar()" class="menu-btn"
            onmouseenter="toggleSidebarMenuIcon(true)" onmouseleave="toggleSidebarMenuIcon(false)">
            <i id="sidebarMenuIcon" data-feather="grid" class="w-6 h-6"></i>
            <span id="menuText" class="hidden ml-2">Menu</span>
          </button>
        </div>

        <nav class="sidebar-nav">
          <a href="#" data-tab="home" onclick="switchTab('home')" class="sidebar-tab active">
            <i data-feather="home"></i>
            <span class="sidebar-text hidden">Home</span>
          </a>
          <a href="#" data-tab="chats" onclick="switchTab('chats')" class="sidebar-tab">
            <i data-feather="message-circle"></i>
            <span class="sidebar-text hidden">Chats</span>
          </a>
          <a href="#" data-tab="friends" onclick="switchTab('friends')" class="sidebar-tab">
            <i data-feather="users"></i>
            <span class="sidebar-text hidden">Friends</span>
          </a>
          <a href="#" data-tab="groups" onclick="switchTab('groups')" class="sidebar-tab">
            <i data-feather="hash"></i>
            <span class="sidebar-text hidden">Groups</span>
          </a>
          <a href="#" data-tab="profile" onclick="switchTab('profile')" class="sidebar-tab">
            <i data-feather="user"></i>
            <span class="sidebar-text hidden">Profile</span>
          </a>
          <a href="#" data-tab="explore" onclick="switchTab('explore')" class="sidebar-tab">
            <i data-feather="compass"></i>
            <span class="sidebar-text hidden">Explore</span>
          </a>
          <a href="#" data-tab="settings" onclick="switchTab('settings')" class="sidebar-tab">
            <i data-feather="settings"></i>
            <span class="sidebar-text hidden">Settings</span>
          </a>
        </nav>
      </div>
      <div>
        <a href="/login.html" class="sidebar-tab logout-link">
          <i data-feather="log-out"></i>
          <span class="sidebar-text hidden">Logout</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <div id="mainContent" class="flex-1 min-w-0 transition-all duration-300 ease-in-out overflow-y-auto">

      <!-- Home Area -->
      <section id="tab-home" class="tab-content ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] flex flex-col space-y-6 hidden mt-5 animate-fadeIn">

        <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-6 rounded-xl shadow-md text-white text-center">
          <h1 class="text-3xl font-bold mb-2">Welcome to Zylo!</h1>
          <p class="text-sm sm:text-base">Connect. Chat. Share. All in one place!</p>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-md border border-gray-200 dark:border-gray-700 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-xl" text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">Friends/Users</p>
            <p class="text-lg font-semibold" id="stat-users">0</p>
          </div>
          <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-md border border-gray-200 dark:border-gray-700 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-xl" text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">Messages</p>
            <p class="text-lg font-semibold" id="stat-messages">0</p>
          </div>
          <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-md border border-gray-200 dark:border-gray-700 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-xl" text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">Rooms/Groups</p>
            <p class="text-lg font-semibold" id="stat-rooms">0</p>
          </div>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">üí° Zylo Tips</h2>
          <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300 list-disc list-inside">
            <li>Click the ‚öôÔ∏è icon to customize your experience.</li>
            <li>Use the chat tab to connect with your team instantly.</li>
            <li>Upload files, images, or audio directly from the chat.</li>
          </ul>
        </div>

        <div>
          <h2 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">üì¢ Announcements</h2>
          <div class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-md border border-gray-200 dark:border-gray-700 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
              <p>üöÄ v1.1 adds Friends and Groups with room chat.</p>
              <p>‚ú® Home quick stats now update from backend.</p>
              <p>ü§ñ Optional AI chat toggle in Chats tab.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Chat Area -->
      <div id="tab-chats" class="tab-content chat-area hidden flex flex-col h-full">

        <!-- Header -->
        <div class="p-3 border-b border-gray-700">
          <h1 class="chat-title text-lg font-bold flex items-center gap-2">üí¨ Chat Rooms</h1>
          <p class="chat-subtitle text-sm text-gray-400">Start chatting with the community or try the AI assistant.</p>
          <div class="flex flex-wrap items-center gap-2 mt-2">
            <div class="inline-flex rounded-md bg-gray-800/70 border border-gray-700 p-1">
              <button id="btnRoomCommunity" class="px-3 py-1 rounded-md text-xs bg-blue-600 text-white" onclick="switchChatRoom('community')">Community</button>
              <button id="btnRoomAI" class="px-3 py-1 rounded-md text-xs text-gray-300 hover:bg-gray-700" onclick="switchChatRoom('ai')">AI Chat</button>
            </div>
            <div id="aiControls" class="hidden items-center gap-2">
              <label for="aiModelSelect" class="text-xs text-gray-400">Model</label>
              <select id="aiModelSelect" class="text-xs bg-gray-800 border border-gray-700 rounded px-2 py-1 text-gray-200"></select>
              <button id="aiClearBtn" class="px-2 py-1 rounded bg-gray-700 text-white text-xs" onclick="clearAiConversation()">Clear</button>
            </div>
          </div>
        </div>

        <!-- Messages Areas -->
        <div id="chatMessagesCommunity" class="chat-messages"></div>
        <div id="chatMessagesAI" class="chat-messages hidden"></div>

        <!-- Typing indicator -->
        <div id="typingIndicator" class="typing-indicator"></div>

        <!-- Input Bar -->
        <div class="chat-input-container flex items-center gap-2 p-3 border-t border-gray-700">

          <!-- Emoji button -->
          <div id="emojiPicker" class="hidden absolute bottom-16 left-4 bg-gray-800 rounded-lg shadow-lg z-50"></div>
          <button class="p-2 rounded hover:bg-gray-700" onclick="openEmojiPicker()" title="Pick an emoji">
            <i data-feather="smile"></i>
          </button>

          <!-- File upload -->
          <label class="p-2 rounded hover:bg-gray-700 cursor-pointer" title="Attach a file">
            <i data-feather="paperclip"></i>
            <input type="file" id="fileInput" class="hidden" onchange="sendFile(event)">
          </label>

          <!-- Text input -->
          <textarea id="chatInput" rows="1" class="chat-input flex-1 resize-none rounded p-2" placeholder="Type your message..."></textarea>

          <!-- Send button -->
          <button onclick="sendMessage()" class="chat-send-btn px-4 py-2 rounded bg-blue-600 text-white">
            <i data-feather="send"></i>
          </button>
        </div>
      </div>


      <!-- Friends Area -->
      <section id="tab-friends" class="tab-content hidden ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] flex flex-col space-y-4 animate-fadeIn">
        <div class="flex items-center gap-2">
          <input id="addFriendInput" type="text" placeholder="Enter username to add" class="zylo-input p-2 flex-1" />
          <button id="addFriendBtn" class="px-3 py-2 bg-blue-600 text-white rounded" onclick="requestFriend()">Add</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 overflow-y-auto">
          <div class="bg-white/70 dark:bg-gray-800/70 rounded-lg p-3">
            <h3 class="font-semibold mb-2">Friends</h3>
            <ul id="friendsList" class="space-y-2 text-sm"></ul>
          </div>
          <div class="bg-white/70 dark:bg-gray-800/70 rounded-lg p-3">
            <h3 class="font-semibold mb-2">Incoming</h3>
            <ul id="incomingList" class="space-y-2 text-sm"></ul>
          </div>
          <div class="bg-white/70 dark:bg-gray-800/70 rounded-lg p-3">
            <h3 class="font-semibold mb-2">Outgoing</h3>
            <ul id="outgoingList" class="space-y-2 text-sm"></ul>
          </div>
        </div>
      </section>

      <!-- Groups Area -->
      <section id="tab-groups" class="tab-content hidden ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] flex flex-col space-y-3 animate-fadeIn">
        <div class="flex items-center gap-2">
          <input id="newGroupName" type="text" placeholder="Group name" class="zylo-input p-2" />
          <input id="newGroupDesc" type="text" placeholder="Description (optional)" class="zylo-input p-2 flex-1" />
          <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="createGroup()">Create</button>
        </div>
        <div class="flex gap-4 flex-1 overflow-hidden">
          <div class="w-64 shrink-0 bg-white/70 dark:bg-gray-800/70 rounded-lg p-3 overflow-y-auto">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">Your Groups</h3>
              <button class="text-xs px-2 py-1 bg-gray-700 text-white rounded" onclick="refreshGroups()">Refresh</button>
            </div>
            <ul id="groupsList" class="space-y-1 text-sm"></ul>
          </div>
          <div class="flex flex-col flex-1 min-w-0">
            <div class="p-2 border-b border-gray-700"><span id="activeGroupTitle" class="font-semibold">Select a group</span></div>
            <div id="groupMessages" class="chat-messages flex-1"></div>
            <div class="chat-input-container flex items-center gap-2 p-3 border-t border-gray-700">
              <label class="p-2 rounded hover:bg-gray-700 cursor-pointer" title="Attach a file to group">
                <i data-feather="paperclip"></i>
                <input type="file" id="groupFileInput" class="hidden" onchange="sendGroupFile(event)">
              </label>
              <textarea id="groupChatInput" rows="1" class="chat-input flex-1 resize-none rounded p-2" placeholder="Message group..."></textarea>
              <button class="chat-send-btn px-4 py-2 rounded bg-blue-600 text-white" onclick="sendGroupMessage()"><i data-feather="send"></i></button>
            </div>
          </div>
        </div>
      </section>


      <!-- Profile Area -->
      <div id="tab-profile" class="tab-content">
        <h1 class="profile-title">üë§ Your Profile</h1>

        <div class="profile-card">

          <!-- Banner -->
          <div class="profile-banner">
            <label for="bannerUpload" class="banner-label">
              <img id="bannerImage" src="/images/default_banner.png" alt="Banner" 
                  class="banner-img">
            </label>
            <button id="saveProfileBtn" onclick="saveProfileChanges()" 
                    class="save-profile-btn hidden absolute top-2 right-2 p-2 rounded-full shadow-lg bg-white dark:bg-gray-800 text-green-600 hover:text-green-700 transition" 
                    title="Save Profile">
              <i data-feather="check"></i>
            </button>
            <input type="file" id="bannerUpload" accept="image/*" class="hidden">

            <!-- Avatar -->
            <div class="avatar-wrapper">
              <label for="avatarUpload" class="avatar-label">
                <img id="avatarImage" src="/images/default_avatar.png" alt="Avatar" 
                    class="avatar-img"/>
              </label>
              <input type="file" id="avatarUpload" accept="image/*" class="hidden">
              <span class="status-dot online"></span>
            </div>
          </div>

          <!-- Profile Content -->
          <div class="profile-content">

            <!-- Username + Tag -->
            <div class="profile-nameblock">
              <h2 id="profileUsername" class="username">ZyloUser</h2>
              <p id="profileUsertag" class="usertag">@zylo1234</p>
            </div>

            <!-- About Me -->
            <div class="about-section">
              <label for="aboutMe">About Me</label>
              <textarea id="aboutMe" rows="3" placeholder="Say something about yourself..."></textarea>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
              <div class="stat-box">
                <p class="stat-label">Level</p>
                <p id="statLevel" class="stat-value">0</p>
              </div>
              <div class="stat-box">
                <p class="stat-label">Gold</p>
                <p id="statGold" class="stat-value gold">0</p>
              </div>
              <div class="stat-box">
                <p class="stat-label">Rank</p>
                <p id="statRank" class="stat-value rank">Unranked</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Crop Modal -->
      <div id="cropperModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 w-full max-w-md space-y-4 shadow-lg">
          <h3 class="text-lg font-semibold text-center text-gray-800 dark:text-white">Adjust your image</h3>

          <div class="w-full h-64 overflow-hidden rounded border dark:border-gray-600">
            <img id="cropperImage" class="max-w-full" />
          </div>

          <div class="flex justify-between items-center gap-2">
            <button onclick="rotateImage(-90)" class="bg-gray-300 dark:bg-gray-700 text-black dark:text-white px-3 py-1 rounded">‚ü≤ Rotate</button>
            <input type="range" min="0.1" max="3" step="0.01" value="1" id="zoomSlider" class="w-full">
            <button onclick="rotateImage(90)" class="bg-gray-300 dark:bg-gray-700 text-black dark:text-white px-3 py-1 rounded">‚ü≥ Rotate</button>
          </div>

          <div class="flex justify-end gap-2">
            <button onclick="closeCropper()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">Cancel</button>
            <button onclick="applyCrop()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Apply</button>
          </div>
        </div>
      </div>

      <!-- Files Area -->
      <div id="tab-files" class="tab-content ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] flex flex-col overflow-y-auto animate-fadeIn">
        <h1 class="text-xl font-bold mb-4 text-white">üì¶ Download Page</h1>

        <div class="mb-6">
          <label for="speed" class="block text-sm font-semibold mb-1">Enter your internet speed (Mbps):</label>
          <input type="number" id="speed" class="w-full border px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="e.g., 50">
          <button onclick="estimateTimes()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Estimate</button>
        </div>

        <div id="downloads" class="space-y-6">
          <!-- File cards will be rendered here -->
        </div>
      </div>

      <!-- Explore Area -->
      <section id="tab-explore" class="tab-content ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] hidden animate-fadeIn">
        <div class="max-w-3xl mx-auto w-full space-y-4">
          <h1 class="text-2xl font-bold">üß≠ Explore</h1>
          <p class="text-gray-300">Share images, videos, audio, or files with the community.</p>

          <!-- Share composer -->
          <div class="p-4 rounded-lg bg-white/10 border border-white/10 space-y-3">
            <div class="flex items-center gap-2">
              <input id="exploreCaption" class="zylo-input flex-1 p-2" placeholder="Say something about your media..." />
              <label class="px-3 py-2 rounded bg-blue-600 text-white cursor-pointer">
                Attach
                <input type="file" id="exploreFile" class="hidden" />
              </label>
              <button id="exploreShareBtn" class="px-3 py-2 rounded bg-green-600 text-white">Share</button>
            </div>
            <div id="explorePreview" class="rounded overflow-hidden"></div>
          </div>

          <!-- Feed -->
          <div id="exploreFeed" class="space-y-3 overflow-y-auto" style="max-height: calc(100dvh - 240px)"></div>
        </div>
      </section>

      <!-- Settings Area -->
      <section id="tab-settings" class="tab-content ml-0 pt-[64px] sm:pt-4 px-2 sm:px-4 w-full h-[100dvh] flex flex-col space-y-6 hidden animate-fadeIn">
        <div class="w-full space-y-8 px-4 sm:px-6 lg:px-8">
          
          <!-- Header -->
          <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold">‚öôÔ∏è Settings (Beta)</h1>
          </div>

          <!-- Settings Navigation -->
          <div class="flex border-b border-gray-300 dark:border-gray-700 mb-6">
            <button class="settings-tab px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 border-b-2 border-transparent" data-target="generalSettings">
              General
            </button>
            <button class="settings-tab px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 border-b-2 border-transparent" data-target="soundSettings">
              Sounds
            </button>
            <button class="settings-tab px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 border-b-2 border-transparent" data-target="accountSettings">
              Account
            </button>
            <button class="settings-tab px-4 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 border-b-2 border-transparent" data-target="aboutSettings">
              About Us
            </button>
          </div>

          <!-- General Settings -->
          <div id="generalSettings" class="settings-content w-full space-y-6">

              <!-- Enable Animations -->
              <div class="flex items-center justify-between">
                <span>Enable Animations</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="animationsToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-300 peer-checked:bg-blue-600 rounded-full peer dark:bg-gray-600 
                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                    after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
                </label>
              </div>

              <!-- Compact Mode -->
              <div class="flex items-center justify-between">
                <span>Compact Mode</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="compactToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-300 peer-checked:bg-purple-600 rounded-full peer dark:bg-gray-600 
                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                    after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
                </label>
              </div>

              <!-- Show Tooltips -->
              <div class="flex items-center justify-between">
                <span>Show Tooltips</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="tooltipToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-300 peer-checked:bg-green-600 rounded-full peer dark:bg-gray-600 
                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                    after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
                </label>
              </div>

              <!-- Language Selector -->
              <div>
                <label for="languageSelect" class="block mb-2">Language</label>
                <select id="languageSelect" class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
                  <option value="en">English</option>
                  <option value="vi">Ti·∫øng Vi·ªát</option>
                  <option value="es">Espa√±ol</option>
                </select>
              </div>

              <!-- Startup Page -->
              <div>
                <label for="startupPage" class="block mb-2">Startup Page</label>
                <select id="startupPage" class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
                  <option value="home">Home</option>
                  <option value="profile">Profile</option>
                  <option value="chats">Messages</option>
                  <option value="friends">Friends</option>
                  <option value="groups">Groups</option>
                  <option value="explore">Explore</option>
                  <option value="settings">Settings</option>
                </select>
              </div>

              <!-- Auto Save Changes -->
              <div class="flex items-center justify-between">
                <span>Auto Save Changes</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="autoSaveToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-300 peer-checked:bg-yellow-500 rounded-full peer dark:bg-gray-600 
                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                    after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
                </label>
              </div>

              <!-- Confirm Before Exit -->
              <div class="flex items-center justify-between">
                <span>Confirm Before Exit</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="confirmExitToggle" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-300 peer-checked:bg-red-500 rounded-full peer dark:bg-gray-600 
                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                    after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
                </label>
              </div>

              <!-- Themes -->
              <div>
                <h2 class="text-xl font-semibold mb-3">Appearance</h2>
                <div class="flex items-center gap-4">
                  <span>Theme:</span>
                  <button onclick="setTheme('light')" data-theme-btn="light"
                    class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white">
                    Light
                  </button>
                  <button onclick="setTheme('dark')" data-theme-btn="dark"
                    class="px-3 py-1 bg-gray-800 hover:bg-gray-900 text-white rounded dark:bg-gray-600 dark:hover:bg-gray-500">
                    Dark
                  </button>
                </div>
              </div>

              <!-- Reset All Settings -->
              <div class="pt-4 border-t border-gray-300 dark:border-gray-700">
                <button onclick="resetAllSettings()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Reset All Settings</button>
              </div>
          </div>

          <!-- Sound Settings -->
          <div id="soundSettings" class="settings-content w-full hidden space-y-6">

            <!-- Sound Effects Volume -->
            <div>
              <label for="soundVolume" class="block mb-2">Sound Effects Volume</label>
              <input type="range" id="soundVolume" min="0" max="100" value="75" 
                    class="w-full accent-blue-500">
            </div>

            <!-- Music Volume -->
            <div>
              <label for="musicVolume" class="block mb-2">Music Volume</label>
              <input type="range" id="musicVolume" min="0" max="100" value="60" 
                    class="w-full accent-green-500">
            </div>

            <!-- Mute All Sounds -->
            <div class="flex items-center justify-between">
              <span>Mute All Sounds</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="muteAll" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-300 peer-checked:bg-red-600 rounded-full peer dark:bg-gray-600 
                  peer-checked:after:translate-x-full peer-checked:after:border-white 
                  after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                  after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
              </label>
            </div>

            <div class="flex items-center gap-2 mb-2">
              <input type="checkbox" id="enableSound" class="accent-blue-500">
              <label for="enableSound">Enable Sound Effects</label>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" id="enableMusic" class="accent-blue-500">
              <label for="enableMusic">Enable Background Music</label>
            </div>
          </div>

          <!-- Account Settings -->
          <div id="accountSettings" class="settings-content w-full hidden space-y-6">

            <!-- Change Username -->
            <div>
              <label class="block mb-2">Change Username</label>
              <input type="text" id="changeUsername" placeholder="Enter new username"
                    class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <button onclick="updateUsername()" 
                      class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Update Username
              </button>
            </div>

            <!-- Change Usertag -->
            <div>
              <label class="block mb-2">Change Usertag</label>
              <input type="text" id="changeUsertag" placeholder="Enter new usertag"
                    class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <button onclick="updateUsertag()" 
                      class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Update Usertag
              </button>
            </div>

            <!-- Change Email -->
            <div>
              <label class="block mb-2">Change Email</label>
              <input type="email" id="changeEmail" placeholder="Enter new email"
                    class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <button onclick="updateEmail()" 
                      class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Update Email
              </button>
            </div>

            <!-- Change Password -->
            <div>
              <label class="block mb-2">Change Password</label>
              <input type="password" id="oldPassword" placeholder="Current password"
                    class="w-full p-2 mb-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <input type="password" id="newPassword" placeholder="New password"
                    class="w-full p-2 mb-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <input type="password" id="confirmPassword" placeholder="Confirm new password"
                    class="w-full p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-gray-800">
              <button onclick="updatePassword()" 
                      class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                Change Password
              </button>
            </div>

            <!-- Two-Factor Authentication -->
            <div class="flex items-center justify-between">
              <span>Two-Factor Authentication (2FA)</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="twoFactorToggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-300 peer-checked:bg-purple-600 rounded-full peer dark:bg-gray-600 
                  peer-checked:after:translate-x-full peer-checked:after:border-white 
                  after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
                  after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
              </label>
            </div>

            <!-- Linked Accounts -->
            <div>
              <h3 class="font-semibold mb-2">Linked Accounts</h3>
              <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg w-full text-left">
                Link Google Account
              </button>
              <button class="mt-2 px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg w-full text-left">
                Link GitHub Account
              </button>
            </div>

            <!-- Privacy -->
            <div>
              <h3 class="font-semibold mb-2">Privacy</h3>
              <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="showEmail" class="accent-blue-500">
                <label for="showEmail">Show Email on Profile</label>
              </div>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="shareActivity" class="accent-blue-500">
                <label for="shareActivity">Share My Activity Status</label>
              </div>
            </div>

            <!-- Danger Zone -->
            <div class="border-t border-gray-300 dark:border-gray-700 pt-4">
              <button onclick="deleteAccount()" 
                      class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white w-full">
                Delete Account
              </button>
            </div>
          </div>

          <!-- About Settings -->
          <div id="aboutSettings" class="settings-content w-full hidden space-y-6">
            
            <!-- App Info -->
            <div>
              <p class="text-gray-600 dark:text-gray-300">
                <strong>Zylo v1.5.7</strong> ‚Äî Created by D4niel-dev
              </p>
              <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
                ¬© 2025 Zylo. All rights reserved.
              </p>
            </div>

            <!-- Version Details -->
            <div>
              <h3 class="text-lg font-semibold mb-2">Version Details</h3>
              <ul class="list-disc list-inside text-gray-600 dark:text-gray-300 text-sm space-y-1">
                <li>Build: 1.5.7-stable</li>
                <li>Release Date: August 2025</li>
                <li>UI Framework: Tailwind CSS</li>
                <li>Backend: Python (Flask)</li>
                <li>Platform: Web/Desktop Hybrid</li>
              </ul>
            </div>

            <!-- Quick Actions -->
            <div>
              <h3 class="text-lg font-semibold mb-2">Quick Actions</h3>
              <div class="flex flex-col gap-2">
                <button onclick="checkForUpdates()" 
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">
                  üîÑ Check for Updates
                </button>
                <button onclick="openChangelog()" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
                  üìú View Changelog
                </button>
                <button onclick="openPrivacyPolicy()" 
                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg shadow">
                  üîí Privacy Policy
                </button>
              </div>
            </div>

            <!-- Credits -->
            <div>
              <h3 class="text-lg font-semibold mb-2">Credits</h3>
              <p class="text-gray-600 dark:text-gray-300 text-sm">
                Special thanks to testers, designers, and contributors who made Zylo possible.
              </p>
            </div>

            <!-- Resources -->
            <div>
              <h3 class="text-lg font-semibold mb-2">Resources</h3>
              <div class="flex flex-col gap-2">
                <a href="https://github.com/D4niel-dev" target="_blank"
                  class="text-blue-600 hover:underline dark:text-blue-400">
                  üîó My GitHub
                </a>
                <a href="https://www.youtube.com/@d4niel_1f" target="_blank"
                  class="text-blue-600 hover:underline dark:text-blue-400">
                  üîó My YouTube
                </a>
                <a href="mailto:zylosupp0rt@gmail.com"
                  class="text-blue-600 hover:underline dark:text-blue-400">
                  üìß Contact Support
                </a>
              </div>
            </div>

            <!-- License -->
            <div>
              <h3 class="text-lg font-semibold mb-2">License</h3>
              <p class="text-gray-600 dark:text-gray-300 text-sm">
                This project is licensed under the MIT License.
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="fixed right-0 top-0 h-full w-80 bg-white/70 dark:bg-gray-900/70 backdrop-blur-md border-l border-gray-200 dark:border-gray-700 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-gray-300 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">‚öô Settings</h2>
        <button onclick="closeSettings()" class="text-gray-500 hover:text-red-500 transform hover:scale-110 transition duration-200">‚úñ</button>
      </div>
      <div class="p-4 space-y-6">

        <!-- Theme Toggle -->
        <div class="flex items-center justify-between">
          <span class="text-gray-700 dark:text-gray-300">Dark Mode</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="themeToggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 dark:peer-focus:ring-blue-400 rounded-full peer dark:bg-gray-600 
              peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white 
              after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
              after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
          </label>
        </div>

        <!-- Notifications Toggle -->
        <div class="flex items-center justify-between">
          <span class="text-gray-700 dark:text-gray-300">Notifications</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="notifToggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-500 dark:peer-focus:ring-green-400 rounded-full peer dark:bg-gray-600 
              peer-checked:bg-green-600 peer-checked:after:translate-x-full peer-checked:after:border-white 
              after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 
              after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500"></div>
          </label>
        </div>

        <!-- Save & Cancel Buttons -->
        <div class="flex gap-2 mt-6">
          <button onclick="saveSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg shadow transition-transform hover:scale-105">Save</button>
          <button onclick="closeSettings()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg shadow transition-transform hover:scale-105">Cancel</button>
        </div>

        <button onclick="openSettingsPage()" class="mt-6 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
          Open Full Settings
        </button>
      </div>
    </div>
  </div>

  <script src="/files/vendor/socket.io.min.js"></script>
  <script>

    // Chat Functions
    const baseUrl = window.location.origin;
    const socket = navigator.onLine ? io(baseUrl) : { emit: function(){}, on: function(){}, off: function(){}};
    const chatInput = document.getElementById("chatInput");
    const chatMessagesCommunity = document.getElementById("chatMessagesCommunity");
    const chatMessagesAI = document.getElementById("chatMessagesAI");
    const aiControls = document.getElementById("aiControls");
    const aiModelSelect = document.getElementById("aiModelSelect");
    let currentChatRoom = localStorage.getItem('chatRoom') || 'community';
    let aiConversation = [];
    const username = localStorage.getItem("savedUsername") || "N/A";
    const email = localStorage.getItem("savedEmail") || "N/A";
    const typingIndicator = document.getElementById("typingIndicator");
    const activeTypers = new Set();
    let emojiPickerVisible = false;

    // Friends & Groups state
    let friendsState = { friends: [], incoming: [], outgoing: [] };
    let groupsState = { list: [], activeId: null };

    chatInput.addEventListener("input", () => {
      if (navigator.onLine && currentChatRoom === 'community') {
        socket.emit("typing", { username });
      }
    });

    chatInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        if (event.shiftKey) {
          event.preventDefault();
          const start = this.selectionStart;
          const end = this.selectionEnd;
          const value = this.value;
          this.value = value.substring(0, start) + "\n" + value.substring(end);
          this.selectionStart = this.selectionEnd = start + 1;
        } else {
          event.preventDefault();
          sendMessage();
        }
      }
    });

    chatInput.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });
    
    function appendCommunityMessage(data) {
      const isOwnMessage = data.username === username;

      // Create message wrapper
      const msgWrapper = document.createElement("div");
      msgWrapper.classList.add("flex", "items-start", "gap-2", "mb-2");
      msgWrapper.classList.add(isOwnMessage ? "justify-end" : "justify-start");
      msgWrapper.classList.add("message", isOwnMessage ? "self" : "other");

      // Add avatar
      const avatar = document.createElement("img");
      avatar.src = `/uploads/${data.username}/avatar.png`;
      avatar.alt = `${data.username}'s avatar`;
      avatar.className = "w-8 h-8 rounded-full object-cover";
      msgWrapper.appendChild(avatar);

      // Create message bubble
      const bubble = document.createElement("div");
      bubble.classList.add("message", isOwnMessage ? "self" : "other");

      // Add header (username + time)
      const header = document.createElement("div");
      header.className = "text-xs opacity-75 mb-1";
      header.textContent = `${data.username} | ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

      // Body (text OR file)
      let body;
      if (data.fileData && data.fileName) {
        const ext = data.fileName.split(".").pop().toLowerCase();
        const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
        const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
        const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac"];

        if (imageExts.includes(ext)) {
          bubble.classList.add("image-bubble");
          body = document.createElement("img");
          body.src = data.fileData;
          body.alt = data.fileName;
          body.className = "max-w-xs rounded shadow cursor-pointer";
        } else if (videoExts.includes(ext)) {
          body = document.createElement("video");
          body.controls = true;
          body.src = data.fileData;
          body.className = "max-w-xs rounded";
        } else if (audioExts.includes(ext)) {
          body = document.createElement("audio");
          body.controls = true;
          body.src = data.fileData;
        } else {
          bubble.classList.add("message", isOwnMessage ? "self" : "other");
          body = document.createElement("a");
          body.href = data.fileData;
          body.download = data.fileName;
          body.textContent = `üìé ${data.fileName}`;
          body.className = "text-blue-400 underline";
        }
      } else if (data.message) {
        bubble.classList.add("message", isOwnMessage ? "self" : "other");
        body = document.createElement("div");
        body.textContent = data.message;
      }

      bubble.appendChild(header);
      if (body) bubble.appendChild(body);

      // Arrange bubble and avatar
      if (isOwnMessage) {
        msgWrapper.appendChild(bubble);
        msgWrapper.appendChild(avatar);
      } else {
        msgWrapper.appendChild(avatar);
        msgWrapper.appendChild(bubble);
      }

      // Append to chat
      chatMessagesCommunity.appendChild(msgWrapper);
      chatMessagesCommunity.scrollTop = chatMessagesCommunity.scrollHeight;
    }

    function appendAiBubble(role, content) {
      const isOwn = role === 'user';

      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'items-start', 'gap-2', 'mb-2');
      wrapper.classList.add(isOwn ? 'justify-end' : 'justify-start');

      const avatar = document.createElement('img');
      avatar.src = isOwn ? (localStorage.getItem('avatar') || '/images/default_avatar.png') : '/images/Zylo_icon.ico';
      avatar.alt = isOwn ? `${username}'s avatar` : 'AI avatar';
      avatar.className = 'w-8 h-8 rounded-full object-cover';

      const bubble = document.createElement('div');
      bubble.classList.add('message', isOwn ? 'self' : 'other');

      const header = document.createElement('div');
      header.className = 'text-xs opacity-75 mb-1';
      header.textContent = `${isOwn ? username : 'AI'} | ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

      const body = document.createElement('div');
      body.textContent = content;

      bubble.appendChild(header);
      bubble.appendChild(body);

      if (isOwn) {
        wrapper.appendChild(bubble);
        wrapper.appendChild(avatar);
      } else {
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
      }

      chatMessagesAI.appendChild(wrapper);
      chatMessagesAI.scrollTop = chatMessagesAI.scrollHeight;
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      if (currentChatRoom === 'community') {
        socket.emit("send_message", { username, message });
        chatInput.value = "";
        chatInput.style.height = "auto";
        return;
      }

      // AI chat path
      const model = aiModelSelect?.value || '';
      const payload = {
        model,
        messages: [...aiConversation, { role: 'user', content: message }]
      };

      // Optimistically render user message
      appendAiBubble('user', message);
      aiConversation.push({ role: 'user', content: message });
      localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      chatInput.value = "";
      chatInput.style.height = "auto";

      try {
        const res = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        const reply = data.reply || data.response || 'Sorry, no reply available.';
        appendAiBubble('assistant', reply);
        aiConversation.push({ role: 'assistant', content: reply });
        localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
      } catch (e) {
        appendAiBubble('assistant', 'There was an error contacting the AI.');
      }
    }

    function openEmojiPicker() {
      const picker = document.getElementById("emojiPicker");
      if (!emojiPickerVisible) {
        picker.classList.remove("hidden");
        const pickerInstance = new EmojiMart.Picker({
          onEmojiSelect: (emoji) => {
            chatInput.value += emoji.native;
            chatInput.focus();
          },
          theme: "dark",
        });
        picker.innerHTML = ""; // Clear existing
        picker.appendChild(pickerInstance);
        emojiPickerVisible = true;
      } else {
        picker.classList.add("hidden");
        emojiPickerVisible = false;
      }
    }

    function sendFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const fileData = e.target.result;

        socket.emit("send_file", {
          username,
          fileName: file.name,
          fileType: file.type,
          fileData: fileData
        });
      };
      reader.readAsDataURL(file); // encodes file as base64
    }

    socket.on("typing", (data) => {
      activeTypers.add(data.username);
      updateTypingIndicator();
      clearTimeout(typingIndicator[data.username]);
      typingIndicator[data.username] = setTimeout(() => {
        activeTypers.delete(data.username);
        updateTypingIndicator();
      }, 2500);
    });

    socket.on("receive_message", (data) => {
      appendCommunityMessage(data);
    });

    socket.on("receive_file", (data) => {
      const isOwnMessage = data.username === username;

      const wrapper = document.createElement("div");
      wrapper.classList.add("flex", "items-start", "gap-2", "mb-2");
      wrapper.classList.add(isOwnMessage ? "justify-end" : "justify-start");

      // Avatar
      const avatar = document.createElement("img");
      avatar.src = `/uploads/${data.username}/avatar.png`;
      avatar.alt = `${data.username}'s avatar`;
      avatar.className = "w-8 h-8 rounded-full object-cover";

      // File bubble
      const bubble = document.createElement("div");
      bubble.classList.add("message", isOwnMessage ? "self" : "other");

      const header = document.createElement("div");
      header.className = "text-xs opacity-75 mb-1";
      header.textContent = `${data.username} | ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

      let fileContent;
      const ext = data.fileName.split(".").pop().toLowerCase();
      const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
      const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
      const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac"];

      if (imageExts.includes(ext)) {
        fileContent = document.createElement("img");
        fileContent.src = data.fileData;
        fileContent.alt = data.fileName;
        fileContent.className = "max-w-xs rounded";
      } else if (videoExts.includes(ext)) {
        const video = document.createElement("video");
        video.controls = true;
        video.src = data.fileData;
        video.className = "max-w-xs rounded";
        fileContent = video;
      } else if (audioExts.includes(ext)) {
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = data.fileData;
        fileContent = audio;
      } else {
        const link = document.createElement("a");
        link.href = data.fileData;
        link.download = data.fileName;
        link.textContent = `üìé ${data.fileName}`;
        link.className = "text-blue-400 underline";
        fileContent = link;
      }

      bubble.appendChild(header);
      bubble.appendChild(fileContent);

      if (isOwnMessage) {
        wrapper.appendChild(bubble);
        wrapper.appendChild(avatar);
      } else {
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
      }

      chatMessagesCommunity.appendChild(wrapper);
      chatMessagesCommunity.scrollTop = chatMessagesCommunity.scrollHeight;
    });

    function updateTypingIndicator() {
      if (activeTypers.size === 0) {
        typingIndicator.classList.add("hidden");
        typingIndicator.textContent = "";
      } else {
        typingIndicator.classList.remove("hidden");
        const users = Array.from(activeTypers);
        if (users.length === 1) {
          typingIndicator.textContent = `${users[0]} is typing...`;
        } else if (users.length === 2) {
          typingIndicator.textContent = `${users[0]} and ${users[1]} are typing...`;
        } else {
          typingIndicator.textContent = `Several people are typing...`;
        }
      }
    }

    if (navigator.onLine) {
      fetch("/api/messages")
        .then((res) => res.json())
        .then((msgs) => msgs.forEach(appendCommunityMessage))
        .catch(() => {});
    } else {
      // Render nothing; app still loads offline
    }

    function switchChatRoom(room) {
      currentChatRoom = room;
      localStorage.setItem('chatRoom', room);
      const btnCommunity = document.getElementById('btnRoomCommunity');
      const btnAI = document.getElementById('btnRoomAI');

      if (room === 'community') {
        chatMessagesCommunity.classList.remove('hidden');
        chatMessagesAI.classList.add('hidden');
        aiControls.classList.add('hidden');
        btnCommunity.classList.add('bg-blue-600', 'text-white');
        btnAI.classList.remove('bg-blue-600', 'text-white');
      } else {
        chatMessagesCommunity.classList.add('hidden');
        chatMessagesAI.classList.remove('hidden');
        aiControls.classList.remove('hidden');
        btnAI.classList.add('bg-blue-600', 'text-white');
        btnCommunity.classList.remove('bg-blue-600', 'text-white');
        // Render saved AI conversation
        restoreAiConversation();
      }
    }

    function restoreAiConversation() {
      try {
        aiConversation = JSON.parse(localStorage.getItem('ai_conversation') || '[]');
      } catch { aiConversation = []; }
      chatMessagesAI.innerHTML = '';
      aiConversation.forEach(msg => appendAiBubble(msg.role, msg.content));
    }

    function clearAiConversation() {
      aiConversation = [];
      localStorage.removeItem('ai_conversation');
      chatMessagesAI.innerHTML = '';
    }

    async function loadAiModels() {
      try {
        const res = await fetch('/api/ai/models');
        const data = await res.json();
        const models = data.models || [];
        aiModelSelect.innerHTML = '';
        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          aiModelSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('ai_model');
        if (saved && models.includes(saved)) {
          aiModelSelect.value = saved;
        }
        aiModelSelect.addEventListener('change', () => {
          localStorage.setItem('ai_model', aiModelSelect.value);
        });
      } catch {}
    }

    // Profile Functions
    // ---- Friends UI logic ----
    async function loadFriends() {
      const u = localStorage.getItem('username');
      if (!u) return;
      try {
        const res = await fetch(`/api/friends?username=${encodeURIComponent(u)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        friendsState = { friends: data.friends || [], incoming: data.incoming || [], outgoing: data.outgoing || [] };
        renderFriends();
      } catch {}
    }

    function renderFriends() {
      const friendsEl = document.getElementById('friendsList');
      const incomingEl = document.getElementById('incomingList');
      const outgoingEl = document.getElementById('outgoingList');
      if (!friendsEl || !incomingEl || !outgoingEl) return;
      friendsEl.innerHTML = '';
      incomingEl.innerHTML = '';
      outgoingEl.innerHTML = '';
      friendsState.friends.forEach(name => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 rounded px-2 py-1';
        li.innerHTML = `<span>${name}</span><button class="text-xs text-red-400" onclick="removeFriend('${name}')">Remove</button>`;
        friendsEl.appendChild(li);
      });
      friendsState.incoming.forEach(name => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 rounded px-2 py-1';
        li.innerHTML = `<span>${name}</span><span class="space-x-1"><button class="text-xs text-green-500" onclick="acceptFriend('${name}')">Accept</button><button class="text-xs text-gray-400" onclick="declineFriend('${name}')">Decline</button></span>`;
        incomingEl.appendChild(li);
      });
      friendsState.outgoing.forEach(name => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 rounded px-2 py-1';
        li.innerHTML = `<span>${name}</span><span class="text-xs opacity-70">Pending</span>`;
        outgoingEl.appendChild(li);
      });
    }

    async function requestFriend() {
      const input = document.getElementById('addFriendInput');
      const to = (input?.value || '').trim();
      const from = localStorage.getItem('username');
      if (!to || !from) return;
      try {
        const res = await fetch('/api/friends/request', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from, to }) });
        await res.json();
        input.value = '';
        loadFriends();
      } catch {}
    }
    async function acceptFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }
    async function declineFriend(from) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/decline', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, from }) });
      loadFriends();
    }
    async function removeFriend(friend) {
      const username = localStorage.getItem('username');
      if (!username) return;
      await fetch('/api/friends/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, friend }) });
      loadFriends();
    }

    // ---- Groups UI logic ----
    function setActiveGroup(group) {
      groupsState.activeId = group?.id || null;
      document.getElementById('activeGroupTitle').textContent = group ? `# ${group.name}` : 'Select a group';
      document.getElementById('groupMessages').innerHTML = '';
      if (!group) return;
      if (navigator.onLine) socket.emit('join_group', { groupId: group.id, username: localStorage.getItem('username') });
      fetch(`/api/groups/${group.id}/messages`).then(r => r.json()).then(msgs => {
        msgs.forEach(m => appendGroupMessage(m));
      }).catch(() => {});
    }

    function appendGroupMessage(data) {
      const isOwnMessage = (data.username || '') === (localStorage.getItem('username') || '');
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'items-start', 'gap-2', 'mb-2');
      wrapper.classList.add(isOwnMessage ? 'justify-end' : 'justify-start');
      const avatar = document.createElement('img');
      avatar.src = `/uploads/${data.username}/avatar.png`;
      avatar.alt = `${data.username}'s avatar`;
      avatar.className = 'w-8 h-8 rounded-full object-cover';
      const bubble = document.createElement('div');
      bubble.classList.add('message', isOwnMessage ? 'self' : 'other');
      const header = document.createElement('div');
      header.className = 'text-xs opacity-75 mb-1';
      header.textContent = `${data.username} | ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      let body;
      if (data.fileData && data.fileName) {
        const ext = (data.fileName.split('.').pop() || '').toLowerCase();
        const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg"];
        const videoExts = ["mp4", "webm", "ogg", "mov", "m4v"];
        const audioExts = ["mp3", "wav", "ogg", "m4a", "aac", "flac"];
        if (imageExts.includes(ext)) {
          body = document.createElement('img');
          body.src = data.fileData;
          body.alt = data.fileName;
          body.className = 'max-w-xs rounded';
        } else if (videoExts.includes(ext)) {
          body = document.createElement('video');
          body.controls = true; body.src = data.fileData; body.className = 'max-w-xs rounded';
        } else if (audioExts.includes(ext)) {
          body = document.createElement('audio');
          body.controls = true; body.src = data.fileData;
        } else {
          body = document.createElement('a');
          body.href = data.fileData; body.download = data.fileName; body.textContent = `üìé ${data.fileName}`; body.className = 'text-blue-400 underline';
        }
      } else {
        body = document.createElement('div');
        body.textContent = data.message;
      }
      bubble.appendChild(header);
      bubble.appendChild(body);
      if (isOwnMessage) { wrapper.appendChild(bubble); wrapper.appendChild(avatar); }
      else { wrapper.appendChild(avatar); wrapper.appendChild(bubble); }
      document.getElementById('groupMessages').appendChild(wrapper);
      const gm = document.getElementById('groupMessages');
      gm.scrollTop = gm.scrollHeight;
    }

    async function refreshGroups() {
      const u = localStorage.getItem('username');
      if (!u) return;
      try {
        const res = await fetch(`/api/groups?username=${encodeURIComponent(u)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        groupsState.list = data.groups || [];
        const listEl = document.getElementById('groupsList');
        listEl.innerHTML = '';
        groupsState.list.forEach(g => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer';
          li.innerHTML = `<span class="truncate"># ${g.name}</span><button class="text-xs text-blue-500" onclick="joinGroup('${g.id}')">Open</button>`;
          li.addEventListener('click', () => setActiveGroup(g));
          listEl.appendChild(li);
        });
      } catch {}
    }

    async function createGroup() {
      const owner = localStorage.getItem('username');
      const name = document.getElementById('newGroupName')?.value?.trim();
      const description = document.getElementById('newGroupDesc')?.value?.trim();
      if (!owner || !name) return;
      try {
        const res = await fetch('/api/groups/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ owner, name, description }) });
        const data = await res.json();
        if (res.ok && data.success) {
          document.getElementById('newGroupName').value = '';
          document.getElementById('newGroupDesc').value = '';
          refreshGroups();
        }
      } catch {}
    }

    async function joinGroup(groupId) {
      const username = localStorage.getItem('username');
      if (!username) return;
      try {
        await fetch('/api/groups/join', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, groupId }) });
        refreshGroups();
        const g = (groupsState.list || []).find(x => x.id === groupId);
        if (g) setActiveGroup(g);
      } catch {}
    }

    function sendGroupMessage() {
      const input = document.getElementById('groupChatInput');
      const message = (input?.value || '').trim();
      if (!message || !groupsState.activeId) return;
      const payload = { groupId: groupsState.activeId, username: localStorage.getItem('username'), message };
      if (navigator.onLine) socket.emit('send_group_message', payload);
      appendGroupMessage(payload);
      input.value = '';
      input.style.height = 'auto';
    }

    function sendGroupFile(event) {
      const file = event.target.files?.[0];
      if (!file || !groupsState.activeId) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const payload = { groupId: groupsState.activeId, username: localStorage.getItem('username'), fileName: file.name, fileType: file.type, fileData: e.target.result };
        if (navigator.onLine) socket.emit('send_group_file', payload);
        // Optimistically render
        appendGroupMessage(payload);
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    if (typeof io !== 'undefined') {
      socket.on('receive_group_message', (data) => {
        if (data.groupId === groupsState.activeId) appendGroupMessage(data);
      });
      socket.on('receive_group_file', (data) => {
        if (data.groupId === groupsState.activeId) appendGroupMessage(data);
      });
    }
    window.addEventListener("DOMContentLoaded", async () => {
        const username = localStorage.getItem("username");
        if (!username) {
            document.getElementById("profileUsername").textContent = "N/A";
            document.getElementById("profileUsertag").textContent = "N/A";
            return;
        }

        try {
            if (!navigator.onLine) throw new Error('offline');
            const res = await fetch(`/api/get-user?identifier=${username}`);
            const data = await res.json();

            if (data.success) {
                const updated = data.user || {};

                document.getElementById("profileUsername").textContent = updated.username;
                document.getElementById("profileUsertag").textContent = updated.usertag;
                document.getElementById("aboutMe").value = updated.aboutMe || "";
                document.getElementById("avatarImage").src = updated.avatar || "/images/default_avatar.png";
                document.getElementById("bannerImage").src = updated.banner || "/images/default_banner.png";
            } else {
                console.error("User not found");
            }
        } catch (err) {
            // Offline fallback: populate from localStorage if available
            const cached = {
              username: localStorage.getItem('username'),
              usertag: localStorage.getItem('usertag'),
              aboutMe: localStorage.getItem('aboutMe') || '',
              avatar: localStorage.getItem('avatar') || '/images/default_avatar.png',
              banner: localStorage.getItem('banner') || '/images/default_banner.png',
              level: parseInt(localStorage.getItem('level') || '0', 10),
              gold: parseInt(localStorage.getItem('gold') || '0', 10),
              rank: localStorage.getItem('rank') || 'Unranked'
            };
            document.getElementById("profileUsername").textContent = cached.username || 'N/A';
            document.getElementById("profileUsertag").textContent = cached.usertag || 'N/A';
            document.getElementById("aboutMe").value = cached.aboutMe;
            document.getElementById("avatarImage").src = cached.avatar;
            document.getElementById("bannerImage").src = cached.banner;
            document.getElementById("statLevel").textContent = cached.level;
            document.getElementById("statGold").textContent = cached.gold;
            document.getElementById("statRank").textContent = cached.rank;
        }
    });

    function saveAboutMe() {
      const about = document.getElementById("aboutMe").value;
      localStorage.setItem("aboutMe", about);
    }

    function updateAvatar(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById("avatarImage").src = e.target.result;
          localStorage.setItem("avatarURL", e.target.result);
        };
        reader.readAsDataURL(file);
      }
    }

    function updateBanner(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById("bannerImage").src = e.target.result;
          localStorage.setItem("bannerURL", e.target.result);
        };
        reader.readAsDataURL(file);
      }
    }

    async function loadStats() {
      const baseUrl = window.location.origin;
      try {
        if (!navigator.onLine) throw new Error('offline');
        const res = await fetch(`${baseUrl}/api/stats`);
        const data = await res.json();
        document.getElementById("stat-users").textContent = data.users;
        document.getElementById("stat-messages").textContent = data.messages;
        document.getElementById("stat-rooms").textContent = data.rooms;
      } catch (err) {
        // Populate with cached or default values when offline
        document.getElementById("stat-users").textContent = localStorage.getItem('stat-users') || '0';
        document.getElementById("stat-messages").textContent = localStorage.getItem('stat-messages') || '0';
        document.getElementById("stat-rooms").textContent = localStorage.getItem('stat-rooms') || '1';
      }
    }

    let cropper = null;
    let currentTarget = null;

    function openCropper(event, targetType) {
      const file = event.target.files[0];
      if (!file) return;

      currentTarget = targetType;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.getElementById('cropperImage');
        img.src = e.target.result;
        document.getElementById('cropperModal').classList.remove('hidden');

        if (cropper) cropper.destroy();

        cropper = new Cropper(img, {
          aspectRatio: targetType === 'avatar' ? 1 : 16 / 5,
          viewMode: 1,
          dragMode: 'move',
          responsive: true,
        });

        const zoomSlider = document.getElementById('zoomSlider');
        if (zoomSlider) {
          zoomSlider.oninput = (ev) => {
            try {
              const level = parseFloat(ev.target.value || '1');
              if (cropper) cropper.zoomTo(level);
            } catch {}
          };
        }
      };
      reader.readAsDataURL(file);

      // reset file input so selecting the same file twice still triggers change
      event.target.value = "";
    }

    function rotateImage(deg) {
      if (cropper) cropper.rotate(deg);
    }

    function closeCropper() {
      cropper?.destroy();
      cropper = null;
      document.getElementById('cropperModal').classList.add('hidden');
      // also clear zoom slider back to default
      const z = document.getElementById('zoomSlider');
      if (z) z.value = '1';
    }

    function applyCrop() {
      const canvas = cropper.getCroppedCanvas({
        width: currentTarget === 'avatar' ? 200 : 800,
        height: currentTarget === 'avatar' ? 200 : 250
      });

      const imageUrl = canvas.toDataURL('image/png');

      if (currentTarget === 'avatar') {
        document.getElementById('avatarImage').src = imageUrl;
        localStorage.setItem('avatar', imageUrl);
      } else if (currentTarget === 'banner') {
        document.getElementById('bannerImage').src = imageUrl;
        localStorage.setItem('banner', imageUrl);
      }

      closeCropper();
      document.getElementById("saveProfileBtn").classList.remove("hidden");
      checkProfileChanges();
    }

    async function loadUserData() {
      const username = localStorage.getItem("username");
      if (!username) return;

      try {
          const res = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
          const data = await res.json();

          if (!data.success) {
              console.error("Failed to load user:", data.error);
              return;
          }

          const user = data.user || {};

          document.getElementById("profileUsername").textContent = user.username || "N/A";
          document.getElementById("profileUsertag").textContent = user.usertag || "N/A";
          document.getElementById("avatarImage").src = user.avatar || "/images/default_avatar.png";
          document.getElementById("bannerImage").src = user.banner || "/images/default_banner.png";
          document.getElementById("aboutMe").value = user.aboutMe || "";
          document.getElementById("statLevel").textContent = user.level || 0;
          document.getElementById("statGold").textContent = user.gold || 0;
          document.getElementById("statRank").textContent = user.rank || "Unranked";

      } catch (err) {
          console.error("Error fetching user data", err);
      }
    }

    /// Optional Status Functions
    function toRoman(num) {
      const roman = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
      return roman[num] || num;
    }

    function getSubTier(levelInRange, rangeSize, maxTier) {
      const tierSize = rangeSize / maxTier;
      let tier = Math.ceil(levelInRange / tierSize);
      if (tier < 1) tier = 1;
      if (tier > maxTier) tier = maxTier;
      return tier;
    }

    function getRank(level) {
      if (level <= 25) return `Stone ${toRoman(getSubTier(level, 25, 5))}`;
      if (level <= 55) return `Metal ${toRoman(getSubTier(level - 25, 30, 5))}`;
      if (level <= 80) return `Gold ${toRoman(getSubTier(level - 55, 25, 5))}`;
      if (level <= 110) return `Mithril ${toRoman(getSubTier(level - 80, 30, 7))}`;
      if (level <= 150) return `Black Mithril ${toRoman(getSubTier(level - 110, 40, 10))}`;
      
      // Master tier logic
      let masterLevel = level - 150;
      if (masterLevel <= 100) {
        return `Master ${toRoman(getSubTier(masterLevel, 100, 5))}`;
      } else if (masterLevel <= 200) {
        return `Grand Master ${toRoman(getSubTier(masterLevel - 100, 100, 5))}`;
      } else {
        return level >= 450 ? "Master Slayer" : `Grand Master ${toRoman(5)}`; // Level 450 special rank
      }
    }

    function getRankColor(rank) {
      const lowered = String(rank || '').toLowerCase();
      if (lowered.startsWith("stone")) return "#808080"; // gray
      if (lowered.startsWith("metal")) return "#a8a9ad"; // silver
      if (lowered.startsWith("gold")) return "#FFD700"; // gold yellow
      if (lowered.startsWith("mithril") && !lowered.startsWith("black")) return "#87CEFA"; // light blue
      if (lowered.startsWith("black mithril")) return "#4682B4"; // dark light blue
      if (lowered.startsWith("grand master")) return "#4B0082"; // dark purple
      if (lowered.startsWith("master slayer")) return "#FF4500"; // Bright orange-red
      if (lowered.startsWith("master")) return "#800080"; // purple
      return "#ffffff"; // default white
    }

    document.addEventListener("keydown", function (e) {
      if (e.ctrlKey && e.key.toLowerCase() === "a") {
        e.preventDefault();
        const levelEl = document.getElementById("statLevel");
        const goldEl = document.getElementById("statGold");
        const rankEl = document.getElementById("statRank");
        let level = parseInt(levelEl?.textContent || '0', 10) || 0;
        let gold = parseInt((goldEl?.textContent || '0').replace(/,/g, ""), 10) || 0;
        level = Math.min(level + 10, 450);
        gold += 1000;
        if (levelEl) levelEl.textContent = String(level);
        if (goldEl) goldEl.textContent = gold.toLocaleString();
        const rank = getRank(level);
        if (rankEl) {
          rankEl.textContent = rank;
          rankEl.style.color = getRankColor(rank);
        }
      }
    });

    const saveBtn = document.getElementById("saveProfileBtn");
    let initialProfileData = {};

    async function saveProfileChanges() {
      const username = localStorage.getItem("username");
      if (!username) return alert("No username found in local storage!");

      try {
        const resUser = await fetch(`/api/get-user?identifier=${encodeURIComponent(username)}`);
        const userData = await resUser.json();
        if (!userData.success) return alert("User not found!");

        const usertag = userData.user.usertag;

        const updatedProfile = {
          username: username,
          usertag: '@' + usertag,
          avatar: document.getElementById("avatarImage").src,
          banner: document.getElementById("bannerImage").src,
          about: document.getElementById("aboutMe").value.trim(),
          level: parseInt(document.getElementById("statLevel").textContent) || 0,
          gold: parseInt(document.getElementById("statGold").textContent.replace(/,/g, "")) || 0,
          rank: document.getElementById("statRank").textContent
        };

        // Send update to backend
        const res = await fetch(`/api/update-profile`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedProfile)
        });

        if (!res.ok) throw new Error("Failed to save profile");
        const data = await res.json();

        if (data.success) {
          const updated = data.user || {};

          document.getElementById("profileUsername").textContent = updated.username || updatedProfile.username;
          document.getElementById("profileUsertag").textContent = updated.usertag || updatedProfile.usertag;
          document.getElementById("avatarImage").src = updated.avatar || updatedProfile.avatar;
          document.getElementById("bannerImage").src = updated.banner || updatedProfile.banner;
          document.getElementById("aboutMe").value = updated.aboutMe || updatedProfile.aboutMe;
          document.getElementById("statLevel").textContent = updated.level ?? updatedProfile.level;
          document.getElementById("statGold").textContent = (updated.gold ?? updatedProfile.gold).toLocaleString();
          document.getElementById("statRank").textContent = updated.rank || updatedProfile.rank;

          // Reset initial data
          captureInitialProfileData();
          document.getElementById("saveProfileBtn").classList.add("hidden");

          if (updated.avatar) {
            document.getElementById("avatarImage").src = updated.avatar + "?t=" + Date.now();
          } else {
            document.getElementById("avatarImage").src = updatedProfile.avatar;
          }
          if (updated.banner) {
            document.getElementById("bannerImage").src = updated.banner + "?t=" + Date.now();
          } else {
            document.getElementById("bannerImage").src = updatedProfile.banner;
          }

          alert("Profile updated!");

        } else {
          alert("Failed to save profile: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("Error saving profile!");
      }
    }

    function captureInitialProfileData() {
      initialProfileData = {
        aboutMe: document.getElementById("aboutMe").value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
    }
    captureInitialProfileData();

    function checkProfileChanges() {
      const currentData = {
        aboutMe: document.getElementById("aboutMe").value.trim(),
        banner: document.getElementById("bannerImage").src,
        avatar: document.getElementById("avatarImage").src
      };
      const hasChanges = JSON.stringify(currentData) !== JSON.stringify(initialProfileData);
      saveBtn.classList.toggle("hidden", !hasChanges);
    }

    // Watch for changes
    document.getElementById("aboutMe").addEventListener("input", checkProfileChanges);
    document.getElementById("bannerUpload").addEventListener("change", (e) => openCropper(e, "banner"));
    document.getElementById("avatarUpload").addEventListener("change", (e) => openCropper(e, "avatar"));

    // Files Functions
    const files = [
      { name: "Zylo_v1.5.7", sizeMB: 94.1, filename: "Zylo_v1.5.7.zip" },
      { name: "Zylo_v1.6.1", sizeMB: 92.1, filename: "Zylo_v1.6.1.zip" },
      { name: "Zylo_v1.6.2", sizeMB: 88.1, filename: "Zylo_v1.6.2.zip" }
    ];

    let estimatedTimes = {};

    function estimateTimes() {
      const speedMbps = parseFloat(document.getElementById('speed').value);
      if (!speedMbps || speedMbps <= 0) {
        alert("Please enter a valid internet speed.");
        return;
      }

      files.forEach(file => {
        const estimatedSeconds = (file.sizeMB * 8) / speedMbps;
        estimatedTimes[file.filename] = estimatedSeconds;
        const timeDisplay = document.getElementById(`time-${file.filename}`);
        if (timeDisplay) {
          timeDisplay.innerText = `‚è±Ô∏è Estimated time: ${estimatedSeconds.toFixed(1)} seconds`;
        }
      });
    }

    function startDownload(filename) {
      const progressBar = document.getElementById(`progress-${filename}`);
      const estimatedTime = estimatedTimes[filename] || 5; 
      let progress = 0;
      const interval = 100; 
      const increment = 100 / ((estimatedTime * 1000) / interval);

      progressBar.style.width = '0%';
      progressBar.classList.remove('bg-green-500');
      const timer = setInterval(() => {
        progress += increment;
        if (progress >= 100) {
          progress = 100;
          clearInterval(timer);
          progressBar.classList.add('bg-green-500');
        }
        progressBar.style.width = `${progress}%`;
      }, interval);

      // Trigger actual download
      const a = document.createElement('a');
      a.href = `/files/${filename}`;
      a.download = filename;
      a.click();
    }

    function renderDownloads() {
      const container = document.getElementById('downloads');
      container.innerHTML = '';

      files.forEach(file => {
        const html = `
          <div class="p-4 border rounded-lg shadow-sm 
                      bg-gray-50/90 dark:bg-gray-800/80 
                      border-gray-200 dark:border-gray-700 
                      text-gray-800 dark:text-gray-100">
            
            <h2 class="text-xl font-semibold">${file.name}</h2>
            <p class="text-sm text-gray-600 dark:text-gray-300">${file.sizeMB} MB</p>
            <p id="time-${file.filename}" class="text-sm text-blue-600 dark:text-blue-400 mt-1">
              ‚è±Ô∏è Estimated time: not calculated
            </p>

            <div class="w-full bg-gray-300 dark:bg-gray-700 rounded h-3 mt-2 overflow-hidden">
              <div id="progress-${file.filename}" 
                  class="bg-blue-500 h-full w-0 transition-all duration-500 ease-in-out">
              </div>
            </div>

            <button onclick="startDownload('${file.filename}')"
                    class="mt-3 px-4 py-2 bg-green-600 text-white rounded 
                          hover:bg-green-700 
                          dark:bg-green-500 dark:hover:bg-green-400">
              Download
            </button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    renderDownloads();

    // Settings Functions

    /// General Settings
    function persistSettings(partial) {
      const username = localStorage.getItem('username');
      if (!username) return;
      fetch('/api/update-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, settings: partial })
      }).catch(() => {});
    }
    const settingsMap = [
      { id: "animationsToggle", key: "enableAnimations" },
      { id: "compactToggle", key: "compactMode" },
      { id: "tooltipToggle", key: "showTooltips" },
      { id: "languageSelect", key: "language" },
      { id: "startupPage", key: "startupPage" },
      { id: "autoSaveToggle", key: "autoSave" },
      { id: "confirmExitToggle", key: "confirmBeforeExit" }
    ];

    window.addEventListener("DOMContentLoaded", () => {
      settingsMap.forEach(({ id, key }) => {
        const el = document.getElementById(id);
        const savedValue = localStorage.getItem(key);
        if (el) {
          if (el.type === "checkbox") el.checked = savedValue === "true";
          else if (savedValue) el.value = savedValue;
        }
      });
      applyGeneralSettings();
    });

    settingsMap.forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", function() {
          const value = this.type === "checkbox" ? this.checked : this.value;
          localStorage.setItem(key, value);
          applyGeneralSettings();
          persistSettings({ [key]: value });
        });
      }
    });

    function applyGeneralSettings() {
      document.body.classList.toggle("no-animations", localStorage.getItem("enableAnimations") === "false");
      document.body.classList.toggle("compact", localStorage.getItem("compactMode") === "true");
      if (localStorage.getItem("showTooltips") === "false") {
        document.querySelectorAll("[title]").forEach(el => el.removeAttribute("title"));
      }
    }

    function resetAllSettings() {
      if (confirm("Are you sure you want to reset all settings?\nThis action can not be undo.")) {
        settingsMap.forEach(({ key }) => localStorage.removeItem(key));
        location.reload();
      }
    }

    if (localStorage.getItem("confirmBeforeExit") === "true") {
      window.addEventListener("beforeunload", function(e) {
        e.preventDefault();
        e.returnValue = '';
      });
    }

    // Event listeners for changes
    document.getElementById("animationsToggle").addEventListener("change", function() {
      localStorage.setItem("enableAnimations", this.checked);
      applyGeneralSettings();
      persistSettings({ enableAnimations: this.checked });
    });

    document.getElementById("compactToggle").addEventListener("change", function() {
      localStorage.setItem("compactMode", this.checked);
      applyGeneralSettings();
      persistSettings({ compactMode: this.checked });
    });

    document.getElementById("tooltipToggle").addEventListener("change", function() {
      localStorage.setItem("showTooltips", this.checked);
      applyGeneralSettings();
      persistSettings({ showTooltips: this.checked });
    });

    document.getElementById("languageSelect").addEventListener("change", function() {
      localStorage.setItem("language", this.value);
      persistSettings({ language: this.value });
      alert("Language set to: " + this.value);
    });

    // Sound settings
    (function initSoundSettings(){
      const soundControls = [
        { id: 'soundVolume', key: 'soundVolume' },
        { id: 'musicVolume', key: 'musicVolume' },
        { id: 'muteAll', key: 'muteAll', checkbox: true },
        { id: 'enableSound', key: 'enableSound', checkbox: true },
        { id: 'enableMusic', key: 'enableMusic', checkbox: true },
      ];
      soundControls.forEach(({ id, key, checkbox }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const saved = localStorage.getItem(key);
        if (saved != null) {
          if (checkbox) el.checked = saved === 'true';
          else el.value = saved;
        }
        el.addEventListener('change', function(){
          const value = checkbox ? this.checked : this.value;
          localStorage.setItem(key, value);
          persistSettings({ [key]: value });
        });
      });
    })();

    /// Account Settings
    async function updateUsername() {
      const newUsername = document.getElementById("changeUsername").value.trim();
      const current = localStorage.getItem('username');
      if (!newUsername) return alert("Please enter a username.");
      if (!current) return alert("You are not logged in.");
      try {
        const res = await fetch('/api/update-username', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: current, newUsername })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('username', data.username);
        const saved = localStorage.getItem('savedUsername');
        if (saved === current) localStorage.setItem('savedUsername', data.username);
        document.getElementById('profileUsername').textContent = data.username;
        alert('Username updated.');
      } catch (e) {
        alert('Failed to update username: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateUsertag() {
      const newTag = document.getElementById("changeUsertag").value.trim();
      const username = localStorage.getItem('username');
      if (!newTag) return alert("Please enter a usertag.");
      if (!/^\d{4}$/.test(newTag)) return alert("Usertag must be exactly 4 digits.");
      try {
        const res = await fetch('/api/update-usertag', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newUsertag: newTag })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        document.getElementById('profileUsertag').textContent = data.usertag;
        localStorage.setItem('usertag', data.usertag);
        alert('Usertag updated.');
      } catch (e) {
        alert('Failed to update usertag: ' + (e.message || 'Unknown error'));
      }
    }

    async function updateEmail() {
      const newEmail = document.getElementById("changeEmail").value.trim();
      const username = localStorage.getItem('username');
      if (!newEmail) return alert("Please enter a new email.");
      try {
        const res = await fetch('/api/update-email', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, newEmail })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        localStorage.setItem('savedEmail', data.email);
        alert('Email updated.');
      } catch (e) {
        alert('Failed to update email: ' + (e.message || 'Unknown error'));
      }
    }

    async function updatePassword() {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;
      const username = localStorage.getItem('username');
      if (!oldPass || !newPass || !confirmPass) return alert("Fill out all password fields.");
      if (newPass !== confirmPass) return alert("New passwords do not match.");
      try {
        const res = await fetch('/api/update-password', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, oldPassword: oldPass, newPassword: newPass })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        alert('Password updated successfully.');
        document.getElementById("oldPassword").value = '';
        document.getElementById("newPassword").value = '';
        document.getElementById("confirmPassword").value = '';
      } catch (e) {
        alert('Failed to update password: ' + (e.message || 'Unknown error'));
      }
    }

    // Two-factor authentication toggle
    document.getElementById("twoFactorToggle").addEventListener("change", function() {
      localStorage.setItem("twoFactorEnabled", this.checked);
      const username = localStorage.getItem('username');
      if (username) {
        fetch('/api/update-settings', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, settings: { twoFactorEnabled: this.checked } })
        }).catch(() => {});
      }
      alert(`Two-Factor Authentication ${this.checked ? 'enabled' : 'disabled'}.`);
    });

    // Privacy toggles
    document.getElementById("showEmail").addEventListener("change", function() {
      localStorage.setItem("showEmail", this.checked);
      const username = localStorage.getItem('username');
      if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { showEmail: this.checked } }) }).catch(() => {});
    });
    document.getElementById("shareActivity").addEventListener("change", function() {
      localStorage.setItem("shareActivity", this.checked);
      const username = localStorage.getItem('username');
      if (username) fetch('/api/update-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, settings: { shareActivity: this.checked } }) }).catch(() => {});
    });

    async function deleteAccount() {
      if (!confirm("Are you sure you want to delete your account?\nThis cannot be undone.")) return;
      const username = localStorage.getItem('username');
      try {
        const res = await fetch('/api/delete-account', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed');
        // Clear local data and go to login
        localStorage.clear();
        window.location.href = '/login.html';
      } catch (e) {
        alert('Failed to delete account: ' + (e.message || 'Unknown error'));
      }
    }

    /// About Settings
    function checkForUpdates() {
      alert("üîÑ Checking for updates...\nNo updates available.");
    }

    function openChangelog() {
      alert("üìú Changelog:\n- Improved settings UI\n- Fixed minor bugs");
    }

    function openPrivacyPolicy() {
      alert("üîí Privacy Policy:\nYour data is stored securely and never shared.");
    }

    // Sidebar + Navbar Functions
    let quickSettingsOpen = false;

    function toggleSidebar() {
      if (window.innerWidth <= 768) {
        const mobileSidebar = document.getElementById("mobileSidebar");
        const overlay = document.getElementById("overlay");
        document.body.classList.toggle("sidebar-open");
        mobileSidebar.classList.toggle("show");
        overlay.classList.toggle("hidden");
        if (mobileSidebar.classList.contains("show")) {
          document.body.style.overflow = "hidden";
        } else {
          document.body.style.overflow = "";
        }
      } else {
        const sidebar = document.getElementById("sidebar");
        const sidebarTexts = document.querySelectorAll(".sidebar-text");
        const menuText = document.getElementById("menuText");
        const isExpanded = sidebar.classList.contains("w-60");
        if (isExpanded) {
          sidebar.classList.remove("w-60");
          sidebar.classList.add("w-20");
          menuText.classList.add("hidden");
          sidebarTexts.forEach(text => text.classList.add("hidden"));
        } else {
          sidebar.classList.remove("w-20");
          sidebar.classList.add("w-60");
          menuText.classList.remove("hidden");
          sidebarTexts.forEach(text => text.classList.remove("hidden"));
        }
      }
    }

    function toggleMenuIcon(isHamburger) {
      const icon = document.getElementById("mobileMenuIcon");
      icon.setAttribute("data-feather", isHamburger ? "menu" : "grid");
      feather.replace();
    }

    function toggleSidebarMenuIcon(isHamburger) {
      const icon = document.getElementById("sidebarMenuIcon");
      icon.setAttribute("data-feather", isHamburger ? "menu" : "grid");
      feather.replace();
    }

    function closeSidebarOnMobile() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    document.addEventListener("keydown", function (e) {
      if (e.key === "Tab" && !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
        e.preventDefault();
        toggleQuickSettings();
      }
    });

    function toggleQuickSettings() {
      const panel = document.getElementById("settingsPanel");
      quickSettingsOpen = !quickSettingsOpen;
      if (quickSettingsOpen) {
        panel.classList.remove("translate-x-full");
        panel.classList.add("translate-x-0");
      } else {
        panel.classList.add("translate-x-full");
        panel.classList.remove("translate-x-0");
      }
    }

    function saveSettings() {
      const isDark = document.getElementById("themeToggle").checked;
      const notifs = document.getElementById("notifToggle").checked;

      localStorage.setItem("theme", isDark ? "dark" : "light");
      localStorage.setItem("notifications", notifs);

      if (isDark) {
        document.body.classList.add("dark");
      } else {
        document.body.classList.remove("dark");
      }

      // Persist to backend (best effort)
      const username = localStorage.getItem('username');
      if (username) {
        fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, settings: { theme: isDark ? 'dark' : 'light', notifications: notifs } })
        }).catch(() => {});
      }

      alert("‚úÖ Settings saved!");
      toggleQuickSettings();
    }

    function openSettings() {
      document.getElementById('settingsPanel').classList.remove('translate-x-full');
    }

    function closeSettings() {
      document.getElementById('settingsPanel').classList.add('translate-x-full');
    }
    function saveSettings() {
      const darkMode = document.getElementById('themeToggle').checked;
      const notifications = document.getElementById('notifToggle').checked;
      localStorage.setItem('theme', darkMode ? 'dark' : 'light');
      localStorage.setItem('notifications', notifications);
      if (darkMode) document.body.classList.add('dark'); else document.body.classList.remove('dark');
      const username = localStorage.getItem('username');
      if (username) {
        fetch('/api/update-settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, settings: { theme: darkMode ? 'dark' : 'light', notifications } })
        }).catch(() => {});
      }
      closeSettings();
    }

    function openSettingsPage() {
      // Close quick settings panel and open full settings tab
      closeSettings();
      switchTab('settings');
      // Highlight the first settings sub-tab
      document.querySelector('.settings-tab')?.click();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark");
      } else if (savedTheme === "light") {
        document.body.classList.remove("dark");
      }

      window.setTheme = function(mode) {
        if (mode === "dark") {
          document.body.classList.add("dark");
          localStorage.setItem("theme", "dark");
        } else {
          document.body.classList.remove("dark");
          localStorage.setItem("theme", "light");
        }
        updateThemeButtons(mode);
      };

      function updateThemeButtons(activeMode) {
        document.querySelectorAll("[data-theme-btn]").forEach(btn => {
          if (btn.dataset.themeBtn === activeMode) {
            btn.classList.add("ring-2", "ring-blue-500");
          } else {
            btn.classList.remove("ring-2", "ring-blue-500");
          }
        });
      }

      if (savedTheme) updateThemeButtons(savedTheme);

      // Initialize chat room + models
      loadAiModels();
      switchChatRoom(currentChatRoom);

      // Explore: wiring share and feed
      const exploreFile = document.getElementById('exploreFile');
      const exploreCaption = document.getElementById('exploreCaption');
      const explorePreview = document.getElementById('explorePreview');
      const exploreFeed = document.getElementById('exploreFeed');
      const exploreShareBtn = document.getElementById('exploreShareBtn');

      function renderPreview(file){
        explorePreview.innerHTML = '';
        if (!file) return;
        const url = URL.createObjectURL(file);
        const type = (file.type || '').toLowerCase();
        if (type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = url; img.className = 'max-h-72 rounded';
          explorePreview.appendChild(img);
        } else if (type.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true; video.src = url; video.className = 'w-full max-h-72 rounded';
          explorePreview.appendChild(video);
        } else if (type.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.controls = true; audio.src = url; audio.className = 'w-full';
          explorePreview.appendChild(audio);
        } else {
          const a = document.createElement('div');
          a.textContent = `üìé ${file.name}`;
          explorePreview.appendChild(a);
        }
      }

      exploreFile?.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        renderPreview(f);
      });

      async function loadExploreFeed(){
        try {
          const res = await fetch('/api/explore/posts');
          const data = await res.json();
          const posts = data.posts || [];
          exploreFeed.innerHTML = '';
          posts.forEach(p => {
            const card = document.createElement('div');
            card.className = 'p-3 rounded-lg bg-white/10 border border-white/10';
            const header = document.createElement('div');
            header.className = 'text-xs opacity-75 mb-2';
            const date = new Date((p.createdAt||0)*1000).toLocaleString();
            header.textContent = `${p.username} ‚Ä¢ ${date}`;
            const caption = document.createElement('div');
            caption.className = 'mb-2';
            caption.textContent = p.caption || '';
            const ext = (p.fileName||'').split('.').pop().toLowerCase();
            const mediaWrap = document.createElement('div');
            if (['png','jpg','jpeg','gif','webp','svg'].includes(ext)) {
              const img = document.createElement('img');
              img.src = p.url; img.className = 'w-full rounded';
              mediaWrap.appendChild(img);
            } else if (['mp4','webm','ogg','mov','m4v'].includes(ext)) {
              const video = document.createElement('video');
              video.controls = true; video.src = p.url; video.className = 'w-full rounded';
              mediaWrap.appendChild(video);
            } else if (['mp3','wav','ogg','m4a','aac','flac'].includes(ext)) {
              const audio = document.createElement('audio');
              audio.controls = true; audio.src = p.url; audio.className = 'w-full';
              mediaWrap.appendChild(audio);
            } else {
              const a = document.createElement('a');
              a.href = p.url; a.download = p.fileName || 'download'; a.textContent = `üìé ${p.fileName || 'file'}`; a.className = 'underline';
              mediaWrap.appendChild(a);
            }
            card.appendChild(header);
            if (caption.textContent) card.appendChild(caption);
            card.appendChild(mediaWrap);
            exploreFeed.appendChild(card);
          });
        } catch {}
      }

      async function shareExplore(){
        const f = exploreFile?.files?.[0];
        if (!f) { alert('Attach a file first.'); return; }
        const caption = exploreCaption?.value || '';
        const username = localStorage.getItem('username') || localStorage.getItem('savedUsername') || 'Anonymous';
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const fileData = e.target.result;
            const res = await fetch('/api/explore/posts', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, caption, fileName: f.name, fileData })
            });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Failed to share');
            // Reset and reload
            if (exploreCaption) exploreCaption.value = '';
            if (exploreFile) exploreFile.value = '';
            explorePreview.innerHTML = '';
            await loadExploreFeed();
          } catch (err) { alert('Failed to share.'); }
        };
        reader.readAsDataURL(f);
      }

      exploreShareBtn?.addEventListener('click', shareExplore);
      loadExploreFeed();

      // Apply startup page if set
      const startup = (localStorage.getItem('startupPage') || 'home');
      const page = startup === 'messages' ? 'chats' : startup;
      switchTab(page);
      // Load social data on entry
      loadFriends();
      refreshGroups();
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));

      const selected = document.getElementById(`tab-${tabName}`);
      if (selected) selected.classList.remove('hidden');

      document.querySelectorAll('.sidebar-tab').forEach(tab => {tab.classList.remove('active');});
      document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(tab => tab.classList.add('active'));
    }

    // Default Functions
    window.onload = () => {
      loadStats();
      loadUserData();
    }
    document.addEventListener("DOMContentLoaded", loadUserData);

    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.getElementById("sidebar");
      const tabs = document.querySelectorAll(".sidebar-tab");
      const menuText = document.getElementById("menuText");
      const sidebarTexts = document.querySelectorAll(".sidebar-text");

      if (sidebar.classList.contains("w-60")) {
        menuText.classList.remove("hidden");
        sidebarTexts.forEach(t => t.classList.remove("hidden"));
        tabs.forEach(tab => {
          tab.classList.remove("justify-center");
          tab.classList.add("justify-start", "pl-3");
        });
      }
    });

    document.querySelectorAll(".settings-tab").forEach(tab => {
      tab.addEventListener("click", function () {
        document.querySelectorAll(".settings-tab").forEach(t => {
          t.classList.remove("border-blue-600", "dark:border-blue-400", "text-blue-600", "dark:text-blue-400");
          t.classList.add("border-transparent");
        });

        // Hide all content
        document.querySelectorAll(".settings-content").forEach(c => c.classList.add("hidden"));

        // Show selected content
        const targetId = this.getAttribute("data-target");
        document.getElementById(targetId).classList.remove("hidden");

        // Highlight active tab
        this.classList.add("border-blue-600", "dark:border-blue-400", "text-blue-600", "dark:text-blue-400");
      });
    });

    document.querySelector(".settings-tab").click();

    function goToPage(href) { 
      document.body.classList.add("fade-out"); 
      setTimeout(() => { 
        window.location.href = href; 
      }, 1000); 
    }

    // Fade-out transition on link clicks
    document.querySelectorAll("a").forEach(link => {
      if (
        link.hostname === window.location.hostname &&
        link.getAttribute("href") &&
        link.getAttribute("href") !== "#" &&
        !link.classList.contains("sidebar-tab")
      ) {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const href = this.getAttribute("href");
          document.body.classList.add("fade-out");
          setTimeout(() => {
            goToPage(href);
          }, 1000);
        });
      }
    });
  </script>
  <script>
    // Offline banner + queued sends
    (function(){
      const banner = document.createElement('div');
      banner.id = 'offlineBanner';
      banner.textContent = 'You are offline. Messages will send when reconnected.';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#b91c1c;color:#fff;padding:8px 12px;text-align:center;z-index:9999;display:none';
      document.body.appendChild(banner);

      function updateBanner(){
        banner.style.display = navigator.onLine ? 'none' : 'block';
      }
      window.addEventListener('online', updateBanner);
      window.addEventListener('offline', updateBanner);
      updateBanner();

      const pendingKey = 'pendingMessages';
      function getQueue(){
        try { return JSON.parse(localStorage.getItem(pendingKey) || '[]'); } catch { return []; }
      }
      function setQueue(arr){ localStorage.setItem(pendingKey, JSON.stringify(arr)); }

      const originalSendMessage = sendMessage;
      window.sendMessage = function(){
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        if (!navigator.onLine) {
          // Only queue community messages. AI requires online access.
          if (typeof currentChatRoom !== 'undefined' && currentChatRoom === 'community') {
            const username = localStorage.getItem('savedUsername') || 'N/A';
            const q = getQueue();
            q.push({ username, message, ts: Date.now() });
            setQueue(q);
          } else {
            // Offline AI: render locally and inform user
            try {
              if (typeof appendAiBubble === 'function') {
                appendAiBubble('user', message);
                if (Array.isArray(aiConversation)) {
                  aiConversation.push({ role: 'user', content: message });
                  localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                }
                appendAiBubble('assistant', 'You are offline. AI chat requires internet.');
                if (Array.isArray(aiConversation)) {
                  aiConversation.push({ role: 'assistant', content: 'You are offline. AI chat requires internet.' });
                  localStorage.setItem('ai_conversation', JSON.stringify(aiConversation));
                }
              }
            } catch (e) {}
          }
          input.value = '';
          input.style.height = 'auto';
          return;
        }
        return originalSendMessage();
      }

      async function flushQueue(){
        if (!navigator.onLine) return;
        const q = getQueue();
        if (!q.length) return;
        try {
          q.forEach(item => {
            if (typeof io !== 'undefined') {
              const s = window.socket || io(window.location.origin);
              s.emit('send_message', { username: item.username, message: item.message });
            }
          });
          setQueue([]);
        } catch (e) {
          // keep queue on error
        }
      }
      window.addEventListener('online', flushQueue);
      setTimeout(flushQueue, 1000);
    })();
  </script>
  <script src="/files/sw-register.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      feather.replace();
    });
  </script>
  <script src="/files/vendor/cropper.min.js"></script>
</body>
</html>