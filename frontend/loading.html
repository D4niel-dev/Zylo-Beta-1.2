<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Zylo | Loading</title>
    <link rel="icon" href="/images/Zylo_icon.ico" type="image/x-icon" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0b1020" />
    <script src="/files/vendor/tailwindcss.js"></script>
    <link rel="stylesheet" href="/files/style.css">
</head>
<body class="text-white h-screen flex items-center justify-center flex-col gap-6">

    <!-- Logo -->
    <img src="/images/Zylo_icon.png" alt="Zylo Logo" class="app-icon w-20 h-20">

    <!-- Welcome -->
    <h2 id="welcomeMsg" class="zylo-heading text-xl font-semibold text-gray-200"></h2>

    <!-- Loading Text -->
    <p id="loadingText" class="zylo-heading text-lg font-medium">
        <span id="taskText"></span>
        <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
    </p>

    <!-- Progress Bar -->
    <div class="progress-wrapper">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <script>
        const tasks = [
          { key: 'init', label: 'Initializing Zylo', run: async () => { await new Promise(r => setTimeout(r, 300)); } },
          { key: 'user', label: 'Fetching user data', run: async () => {
              const u = localStorage.getItem('username');
              if (!u) return;
              try { await fetch(`/api/get-user?identifier=${encodeURIComponent(u)}`); } catch {}
          } },
          { key: 'messages', label: 'Loading chats', run: async () => {
              try { await fetch('/api/messages', { method: 'GET' }); } catch {}
          } },
          { key: 'groups', label: 'Syncing groups', run: async () => {
              const u = localStorage.getItem('username');
              if (!u) return;
              try { await fetch(`/api/groups?username=${encodeURIComponent(u)}`); } catch {}
          } },
          { key: 'explore', label: 'Fetching explore feed', run: async () => {
              try { await fetch('/api/explore/posts'); } catch {}
          } },
          { key: 'cache', label: 'Priming offline cache', run: async () => { try { await caches.open('runtime-v1-zylo'); } catch {} } },
        ];

        let index = 0;
        const textEl = document.getElementById("taskText");
        const progressBar = document.getElementById("progressBar");
        const welcomeEl = document.getElementById("welcomeMsg");

        // Show welcome with stored username
        const username = localStorage.getItem("username");
        if (username) {
            welcomeEl.textContent = `Welcome back, ${username}!`;
        }

        async function runNext() {
          if (index >= tasks.length) return;
          const task = tasks[index];
          textEl.textContent = task.label;
          try { await task.run(); } catch {}
          index++;
          progressBar.style.width = `${(index/tasks.length) * 100}%`;
          if (index < tasks.length) {
            setTimeout(runNext, 250);
          } else {
            done();
          }
        }

        function goToPage(href) { 
            document.body.classList.add("fade-out"); 
            setTimeout(() => { 
                window.location.href = href; 
            }, 1000); 
        }

        function done(){
          textEl.textContent = "Done!";
          document.querySelector(".loading-dots").style.display = "none";
          progressBar.style.width = "100%";
          setTimeout(() => {
            document.body.style.animation = "fadeOut 1s forwards";
            setTimeout(() => { goToPage("mainapp.html"); }, 900);
          }, 500);
        }

        window.addEventListener('load', () => {
          runNext();
        });

        // Fade-out transition on link clicks
        document.querySelectorAll("a").forEach(link => {
        if (link.hostname === window.location.hostname) {
            link.addEventListener("click", function (e) {
            e.preventDefault();
            const href = this.getAttribute("href");
            document.body.classList.add("fade-out");
            setTimeout(() => {
                goToPage(href);
            }, 1000);
            });
        }
        });

        // Apply saved theme (from localStorage)
        const savedTheme = localStorage.getItem('theme');

        if (savedTheme === 'dark') {
            document.body.classList.add("dark");
        } else if (savedTheme === 'light') {
            document.body.classList.remove("dark");
        }
    </script>
    <script src="/files/sw-register.js"></script>
</body>
</html>
